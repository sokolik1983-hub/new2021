<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Ависалес</title>
	<link rel="stylesheet" href="style.css">

</head>

<body>
<h1>Авиасалес11222</h1>
<main>
	<section class="wrapper">
		<form class="form-search">
			<div class="wrapper__search">
				<div class="input" style="display: block;">
					<label>Откуда
						<input type="text" class="input__cities-from" required>
					</label>
					<ul class="dropdown dropdown__cities-from">

					</ul>
				</div>

				<div class="input">
					<label>Куда
						<input type="text" class="input__cities-to" required>
					</label>
					<ul class="dropdown dropdown__cities-to">

					</ul>
				</div>

				<div class="input input__cities-from">
					<label>Отправление
						<input type="date" class="input__date-depart" required>
					</label>
				</div>
			</div>

			<div class="wrapper__button">
				<button type="submit" class="button button__search">
					<span class="button__search-text">Найти билеты</span>
				</button>
			</div>
		</form>
	</section>
	<section class="wrapper">

		<section class="wrapper__ticket" id="cheapest-ticket">
			<h2>Самый дешевый билет на выбранную дату</h2>

		</section>

		<section class="block__ticket" id="other-cheap-tickets">
			<h2>Самые дешевые билеты на другие даты</h2>
		</section>
	</section>
</main>
<script>
	const formSearch = document.querySelector('.form-search'),
			inputCitiesFrom = document.querySelector('.input__cities-from'),
			dropdownCitiesFrom = document.querySelector('.dropdown__cities-from'),
			inputCitiesTo = document.querySelector('.input__cities-to'),
			dropdownCitiesTo = document.querySelector('.dropdown__cities-to'),
			inputDateDepart = document.querySelector('.input__date-depart'),
			cheapestTicket = document.querySelector('#cheapest-ticket'),
			otherCheapTickets = document.querySelector('#cheapest-ticket');

	const obj = {
		key: 'value',
		'key two': 'value2',
		key3: false,
		key4: {
			a: 1,
			b: 'dva',
		},
		keyNext: ['array', 5, {a: 1, b: 2}, [true, false, 0]],
	}

	//Данные
	const citiesApi = './database/cities.json',
			proxy = 'https://cors-anywhere.herokuapp.com/',
			apiKEY = '0d957685c6bf0fff4924547d548feffa',
			calendar = 'http://min-prices.aviasales.ru/calendar_preload';
	let city = []; //список городов

	//Запрос в авиасейлс по городам
	const getData = (url, callback) => {
		const request = new XMLHttpRequest();
		request.open('GET', url);

		request.addEventListener('readystatechange', () => {
			if (request.readyState !== 4) return;

			if (request.status === 200) {
				callback(request.response);
			} else {
				console.error(request.status)
			}
		})
		request.send();
	}


	//функция показываем отфильтрованные города в выпадающем списке
	const showCity = (input, list) => {
		list.textContent = ''; //очищаем список, после каждого ввода
		if (input.value !== '') { //условие, когда инпут непустой показываем список городов, когда пустой функция не срабатывает
			const filterCity = city.filter((item) => { //новый массив для фильтрованного списка
				const fixItem = item.name.toLowerCase(); //приводим все названия городов к нижнему регистру
				return fixItem.startsWith(input.value.toLowerCase()); //приводим введённый в инпуте символ к нижнему регистру, далее если айтем содержит элемент ввода в инпут-- возвращаем в новый массив
				//Также startWith выводит значение в выпадающем меню с первой введённой буквы,а не по всему слову, например в инпуте пишем "М" и нам выводятся города, начинающиеся с буквы "М"
			})
			filterCity.forEach((item) => { //в фильтрованном массиве создаём лишку для списка
				const li = document.createElement('li');
				li.classList.add('dropdown__city');
				li.textContent = item.name;
				list.append(li);
			});
		}
	}
	//функция вставляем кликнутый ли (выбранный город) в значение инпут
	const enterCityInput = (event, input, list) => {
		const target = event.target; //определяем кликнутый ли
		if (target.tagName.toLowerCase() === 'li') { // проверяем ли , ли это
			input.value = target.textContent; //вставляем значение ли в инпут
			list.textContent = '';//убираем выпадающее меню
		}
		;
	}
	//Вместо кодов города в вёрстке, выводим название городов
	const getNameCity = (code) => { //получаем код города от функции, вызываемой в вёрстке
		const objCity = city.find((item) => item.code === code); //ищем в массиве городов city совпадение по коду
		console.log(objCity);
		return objCity.name;//когда совпадение найдено, возвращаем в вёсртку название города вместо кода
	}



	//В вёрстку строки самый дешёвый билет, в зависимости от поступивших данных с сервера вставляем строку
	const getChanges = (num) => {
		if(num) {
			return num === 1 ? 'С одной пересадкой' : 'С двумя пересадками'
		} else {
			return 'Без пересадок'
		}
	}

	//Меняем дату в вёрстке на удобоваримую и более читабельную
	const getDate = (date) => {
		return new Date(date).toLocaleString('ru', {
			year: 'numeric',
			month: 'long',
			day: 'numeric',
			hour: '2-digit',
			minute: '2-digit'
		})
	}

	const createCard = (data) => {
		const ticket = document.createElement('article');
		ticket.classList.add('ticket');

		let deep = '';

		if(data) {
			deep = `<h3 class="agent">${data.gate}</h3>
<div class="ticket__wrapper">
\t<div class="left-side">
\t\t<a href="https://www.aviasales.ru/search/SVX2905KGD1" class="button button__buy">Купить
\t\t\tза ${data.value}₽</a>
\t</div>
\t<div class="right-side">
\t\t<div class="block-left">
\t\t\t<div class="city__from">Вылет из города
\t\t\t\t<span class="city__name">${getNameCity(data.origin)}</span>
\t\t\t</div>
\t\t\t<div class="date">${getDate(data.depart_date)}</div>
\t\t</div>

\t\t<div class="block-right">
\t\t\t<div class="changes">${getChanges(data.number_of_changes)}</div>
\t\t\t<div class="city__to">Город назначения:
\t\t\t\t<span class="city__name">${getNameCity(data.destination)}</span>
\t\t\t</div>
\t\t</div>
\t</div>
</div>` ;
		} else {
			deep ='<h3>На текущую дату билетов нет</h3>'
		}

		ticket.insertAdjacentHTML('afterbegin', deep)



		return ticket;
	}
	const renderCheapDay = (cheapTicket) => {
		const ticket = createCard(cheapTicket[0]);
		cheapestTicket.append(ticket);
	};
	const renderCheapYear = (cheapTickets) => {
		cheapTickets.sort((a,b) => { //фильтруем по цене, от самой дешёвой к самой дорогой
			if (a.value > b.value) {
				return 1;
			}
			if (a.value < b.value) {
				return -1;
			}
			return  0;
		});

		//Более короткий вариант сортировки по числам
		// cheapTickets.sort((a,b) => a.value - b.value);

		console.log(cheapTickets)
	};

	const renderCheap = (data, date) => {
		const cheapTicketYear = JSON.parse(data).best_prices; //Забираем из data все рейсы из заданных городов
		const cheapTicketDay = cheapTicketYear.filter((item) => { //Фильтруем рейсы на сегодняшнее число
			return item.depart_date === date;
		});
		renderCheapDay(cheapTicketDay);
		renderCheapYear(cheapTicketYear);
	}


	//Обработчики событий

	//Манипуляции с городами в инпуте ввода "откуда"
	inputCitiesFrom.addEventListener('input', () => {
		showCity(inputCitiesFrom, dropdownCitiesFrom); //передаём в функцию нужный инпут и нужный выпадающий список
	});
	//Манипуляции с городами в инпуте ввода "откуда"
	inputCitiesTo.addEventListener('input', () => {
		showCity(inputCitiesTo, dropdownCitiesTo); //передаём в функцию нужный инпут и нужный выпадающий список
	});

	//Кликаем по выпавшему списку и вставляем значение в инпут велью "откуда"
	dropdownCitiesFrom.addEventListener('click', (event) => {
		enterCityInput(event, inputCitiesFrom, dropdownCitiesFrom);
	});
	//Кликаем по выпавшему списку и вставляем значение в инпут велью "куда"
	dropdownCitiesTo.addEventListener('click', (event) => {
		enterCityInput(event, inputCitiesTo, dropdownCitiesTo);
	});
	//При удачной отправке формы, создаётся объект с параметрами заказа
	formSearch.addEventListener('submit', (event) => {
		event.preventDefault();
		cheapestTicket.textContent =''; //очищаем поля результатов поиска, после каждого ново
		const cityFrom = city.find((item) => {
			return inputCitiesFrom.value === item.name  //Возвращаем , когда находим совпадение данных из инпута с данными из city
		})
		const cityFind = city.find((item) => {
			return inputCitiesTo.value === item.name //Возвращаем , когда находим совпадение данных из инпута с данными из city
		})

		const formData = {
			from: cityFrom, //код города
			to: cityFind,
			when: inputDateDepart.value
		}

		if(formData.from && formData.to) { //Проверяем введённые названия городов в инпутах, если нет такого названия, то алерт!!
			const requestData = `?depart_date=${formData.when}&origin=${formData.from.code}&destination=${formData.to.code}&one_way=true&token=${apiKEY}`

			getData(proxy + calendar + requestData, (response) => {
				renderCheap(response, formData.when);
			})
		} else {
			alert('Введите название города!!')
		}
	})


	//Вызовы функций
	//получаем данные о перелётах и фильтруем
	getData(citiesApi, (data) => {
		city = JSON.parse(data).filter((item) => {
			return item.name;//возвращаются только города у котрых есть имя на русском
		});
		city.sort((a,b) => {
			if (a.name > b.name) {
				return 1;
			}
			if (a.name < b.name) {
				return -1;
			}
			return  0;
		});
	});


</script>
</body>

</html>


